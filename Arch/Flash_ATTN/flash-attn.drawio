<mxfile host="Electron" modified="2024-05-11T02:52:01.567Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/24.2.5 Chrome/120.0.6099.109 Electron/28.1.0 Safari/537.36" etag="2BxKoP6wH-7E4ph6cWug" version="24.2.5" type="device">
  <diagram name="第 1 页" id="lJStV8RaI5A1z8thdrf8">
    <mxGraphModel dx="3084" dy="2232" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="DAtmgXmAGLAijf5BrxrI-2" value="q&lt;div&gt;[total_q, head_num, head_size]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="130" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-3" value="&lt;div&gt;v&lt;/div&gt;&lt;div&gt;[total_v, head_num, head_size]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="540" y="130" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-4" value="&lt;div&gt;k&lt;/div&gt;&lt;div&gt;[total_k, head_num, head_size]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="310" y="130" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-6" value="out&lt;div&gt;[total_q, head_num, head_size]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="280" y="2080" width="236" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-7" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;cu_seqlens_q&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;[batch+1]&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="230" y="290" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-8" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;cu_seqlens_k&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;[batch+1]&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="470" y="290" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-9" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;block_table_&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;[&lt;span style=&quot;color: rgb(106, 153, 85);&quot;&gt;batch_size, &lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: rgb(106, 153, 85);&quot;&gt;max_num_blocks_per_seq]&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="-130" y="290" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-10" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="210" as="sourcePoint" />
            <mxPoint x="400" y="630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-11" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;TORCH_CHECK&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="310" y="380" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-12" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;paged_KV?&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="296" y="420" width="96" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-14" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;GQA相关：ngroups&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;num_heads&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;/&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;num_heads_k&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="80" y="460" width="280" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-15" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;控制batch内哪些k会被使用：seqused_k&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="210" y="500" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-16" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;head_dim补为8的倍数：head_size_og &lt;span style=&quot;color: #d4d4d4;&quot;&gt;%&lt;/span&gt; &lt;span style=&quot;color: #b5cea8;&quot;&gt;8&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;!=&lt;/span&gt; &lt;span style=&quot;color: #b5cea8;&quot;&gt;0&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="190" y="540" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-17" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;方便做tiling：out&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;reshape&lt;/span&gt;({batch_size, num_heads_k, ngroups, head_size_og}).&lt;span style=&quot;color: #dcdcaa;&quot;&gt;transpose&lt;/span&gt;(&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;, &lt;span style=&quot;color: #b5cea8;&quot;&gt;2&lt;/span&gt;).&lt;span style=&quot;color: #dcdcaa;&quot;&gt;reshape&lt;/span&gt;({batch_size &lt;span style=&quot;color: #d4d4d4;&quot;&gt;*&lt;/span&gt; ngroups, num_heads_k, head_size_og})&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-220" y="570" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-19" target="DAtmgXmAGLAijf5BrxrI-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-19" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #569cd6;&quot;&gt;const&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;int&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;head_size&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;round_multiple&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;head_size_og&lt;/span&gt;, &lt;span style=&quot;color: #b5cea8;&quot;&gt;8&lt;/span&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #569cd6;&quot;&gt;const&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;int&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;head_size_rounded&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;round_multiple&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;head_size&lt;/span&gt;, &lt;span style=&quot;color: #b5cea8;&quot;&gt;32&lt;/span&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #569cd6;&quot;&gt;const&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;int&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;seqlen_q_rounded&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;round_multiple&lt;/span&gt;(max_seqlen_q, &lt;span style=&quot;color: #b5cea8;&quot;&gt;128&lt;/span&gt;);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #569cd6;&quot;&gt;const&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;int&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;seqlen_k_rounded&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;round_multiple&lt;/span&gt;(max_seqlen_k, &lt;span style=&quot;color: #b5cea8;&quot;&gt;128&lt;/span&gt;);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="105" y="640" width="600" height="110" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-20" target="DAtmgXmAGLAijf5BrxrI-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-20" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;set_params_fprop&lt;/span&gt;(params,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;batch_size,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;max_seqlen_q, max_seqlen_k,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;seqlen_q_rounded, seqlen_k_rounded,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;num_heads, num_heads_k,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;head_size, head_size_rounded,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;q_padded, k_padded, v_padded, out,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;cu_seqlens_q_d,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;cu_seqlens_k&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;data_ptr&lt;/span&gt;(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;seqused_k&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;has_value&lt;/span&gt;() &lt;span style=&quot;color: #d4d4d4;&quot;&gt;?&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;seqused_k&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;value&lt;/span&gt;().&lt;span style=&quot;color: #dcdcaa;&quot;&gt;data_ptr&lt;/span&gt;() &lt;span style=&quot;color: #d4d4d4;&quot;&gt;:&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;nullptr&lt;/span&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;return_softmax &lt;span style=&quot;color: #d4d4d4;&quot;&gt;?&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;p&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;data_ptr&lt;/span&gt;() &lt;span style=&quot;color: #d4d4d4;&quot;&gt;:&lt;/span&gt; &lt;span style=&quot;color: #569cd6;&quot;&gt;nullptr&lt;/span&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;softmax_lse&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;data_ptr&lt;/span&gt;(),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;p_dropout,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;softmax_scale,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;window_size_left,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;window_size_right,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;seqlenq_ngroups_swapped);&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="72.5" y="800" width="665" height="380" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-22" target="DAtmgXmAGLAijf5BrxrI-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-22" value="&lt;div style=&quot;color: #cccccc;background-color: #1f1f1f;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run_mha_fwd&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;(params, stream, paged_KV);&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="177.5" y="1255" width="455" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-25" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font style=&quot;font-size: 24px;&quot;&gt;重要讲解链接：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;font size=&quot;3&quot;&gt;https://zhuanlan.zhihu.com/p/688345042&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="-220" y="10" width="380" height="30" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-26" target="DAtmgXmAGLAijf5BrxrI-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-26" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run_mha_fwd_&lt;/span&gt;&amp;lt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;elem_type&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;kHeadDim&lt;/span&gt;&amp;gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;params&lt;/span&gt;, &lt;span style=&quot;color: #9cdcfe;&quot;&gt;stream&lt;/span&gt;);&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="187.5" y="1380" width="435" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-28" target="DAtmgXmAGLAijf5BrxrI-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-28" value="generate_kernels.py&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;run_mha_fwd_hdim&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{HEAD_DIM}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{DTYPE}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;&amp;gt;(params, stream);&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="197.5" y="1500" width="415" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-30" target="DAtmgXmAGLAijf5BrxrI-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-30" value="flash_fwd_launch_template.h&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run_mha_fwd_hdim32()&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="282.5" y="1630" width="245" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-32" target="DAtmgXmAGLAijf5BrxrI-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-32" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;flash_fwd_kernel&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 19px;&quot;&gt;kernel&lt;span style=&quot;color: #d4d4d4;&quot;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt;grid, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Kernel_traits&lt;/span&gt;::kNThreads, smem_size, stream&lt;span style=&quot;color: #d4d4d4;&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;(params);&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="117.5" y="1754" width="575" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="DAtmgXmAGLAijf5BrxrI-34" target="DAtmgXmAGLAijf5BrxrI-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-34" value="flash_fwd_kernel.h&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;flash&lt;/span&gt;::&lt;span style=&quot;color: #dcdcaa;&quot;&gt;compute_attn&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="-170" y="1870" width="215" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-36" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;flash&lt;/span&gt;::&lt;span style=&quot;color: #dcdcaa;&quot;&gt;compute_attn_1rowblock&lt;/span&gt;&amp;lt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Kernel_traits&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Is_dropout&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Is_causal&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Is_local&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Has_alibi&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Is_even_MN&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Is_even_K&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Return_softmax&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;(params, bidb, bidh, m_block);&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="-900" y="1980" width="1227.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="DAtmgXmAGLAijf5BrxrI-38" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="440" y="1830" as="sourcePoint" />
            <mxPoint x="440" y="2060" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="khu91ScEa7h5S4R1IuwK-1" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;mha_varlen_fwd&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="338" y="-40" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khu91ScEa7h5S4R1IuwK-2" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="404.29" y="32" as="sourcePoint" />
            <mxPoint x="404.29" y="112" as="targetPoint" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
