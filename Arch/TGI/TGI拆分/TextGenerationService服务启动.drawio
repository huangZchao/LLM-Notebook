<mxfile host="Electron" modified="2024-06-07T06:53:24.800Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/24.2.5 Chrome/120.0.6099.109 Electron/28.1.0 Safari/537.36" etag="pHYtPFnndKQR4HeXaoi_" version="24.2.5" type="device" pages="4">
  <diagram id="SqpgA9lJfB61F59VVJIq" name="Launcher">
    <mxGraphModel dx="1347" dy="744" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-1" target="8fM9SgASZ_8XMaOO6QfT-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-1" value="服务启动入口&lt;div&gt;launcher/main.rs&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="330" y="140" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-2" target="8fM9SgASZ_8XMaOO6QfT-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-2" value="校验参数" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="330" y="230" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-4" target="8fM9SgASZ_8XMaOO6QfT-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-4" value="获取shard数量（即模型并行度TP）&lt;div&gt;&lt;div style=&quot;background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: rgb(206, 145, 120);&quot;&gt;ASCEND_RT_VISIBLE_DEVICES&lt;/span&gt;&lt;font color=&quot;#f8f7f6&quot;&gt;或者启动参数设置&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="225" y="330" width="330" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-6" target="8fM9SgASZ_8XMaOO6QfT-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-6" value="创建模型服务&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;spawn_shards&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="330" y="470" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-8" target="8fM9SgASZ_8XMaOO6QfT-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-8" value="创建请求服务&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;spawn_webserver&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="330" y="610" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-12" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="460" y="500" as="sourcePoint" />
            <mxPoint x="570" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-13" target="8fM9SgASZ_8XMaOO6QfT-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-13" value="按num_shard创建对应数量的模型服务&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;shard_manager&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="580" y="470" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="afpWN4tFc4fNERLYsOLc-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="8fM9SgASZ_8XMaOO6QfT-14" target="afpWN4tFc4fNERLYsOLc-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-14" value="创建命令为&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;text-generation-server&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="850" y="470" width="205" height="60" as="geometry" />
        </mxCell>
        <mxCell id="8fM9SgASZ_8XMaOO6QfT-16" value="创建命令为&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;text-generation-router&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="570" y="610" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="afpWN4tFc4fNERLYsOLc-1" value="通过pyproject.toml链到&lt;div&gt;text-generate-server/server.py&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1130" y="470" width="167.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="j8MMWJbs8Y2KiwgAFLxC-1" value="" style="curved=1;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="810" y="640" as="sourcePoint" />
            <mxPoint x="960" y="540" as="targetPoint" />
            <Array as="points">
              <mxPoint x="880" y="640" />
              <mxPoint x="910" y="570" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="j8MMWJbs8Y2KiwgAFLxC-2" value="client" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="827" y="640" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="j8MMWJbs8Y2KiwgAFLxC-3" value="server" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="940" y="550" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="j8MMWJbs8Y2KiwgAFLxC-5" value="请求" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="887" y="585" width="90" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="bvo3i7HECF0Yc3GEDmf4" name="text-generation-router">
    <mxGraphModel dx="1347" dy="744" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="l9--Gc5wlDO2-LVOBnj8-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="l9--Gc5wlDO2-LVOBnj8-1" target="l9--Gc5wlDO2-LVOBnj8-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l9--Gc5wlDO2-LVOBnj8-1" value="请求服务入口&lt;div&gt;router/main.rs&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="230" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="l9--Gc5wlDO2-LVOBnj8-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="l9--Gc5wlDO2-LVOBnj8-2" target="l9--Gc5wlDO2-LVOBnj8-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l9--Gc5wlDO2-LVOBnj8-2" value="参数校验" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="330" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="l9--Gc5wlDO2-LVOBnj8-4" target="XuCRXoDc4IViZIX7bLIx-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="l9--Gc5wlDO2-LVOBnj8-4" value="如果有tokenizer.json，则加载（加速tokenize）" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="220" y="430" width="180" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-1" target="XuCRXoDc4IViZIX7bLIx-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-1" target="XuCRXoDc4IViZIX7bLIx-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-1" value="创建shardedClient" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="540" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-3" target="XuCRXoDc4IViZIX7bLIx-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-3" value="实际是多个客户端&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Vec&lt;/span&gt;&amp;lt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Client&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="450" y="540" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-5" value="Client实际是&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;TextGenerationServiceClient&lt;/span&gt;&amp;lt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Channel&lt;/span&gt;&amp;gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="540" width="310" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-7" target="XuCRXoDc4IViZIX7bLIx-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-7" value="调用clear_cache()" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="650" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-9" target="XuCRXoDc4IViZIX7bLIx-11" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-9" value="调用warmup" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="770" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="XuCRXoDc4IViZIX7bLIx-11" target="XuCRXoDc4IViZIX7bLIx-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-11" value="启动服务&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;server&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;::&lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;run&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="250" y="880" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="XuCRXoDc4IViZIX7bLIx-14" value="调用server.rs的run()" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="450" y="880" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--1" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="590" y="850" width="20" height="120" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--2" value="创建validation对象&lt;div&gt;对输入进行处理&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="830" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--3" value="创建infer对象&lt;div&gt;做推理&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="890" width="170" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--4" value="启动服务，并提供请求url&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;Router&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;::&lt;/span&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;new&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="620" y="950" width="185" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--5" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="820" y="980" width="20" height="120" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--6" value="&lt;div style=&quot;color: #cccccc;background-color: #1f1f1f;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;/generate&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="850" y="970" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="uufldpvzKON03YWBHDo--7" target="g-QWhA116RUE6NQJ05dA-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--7" value="&lt;div style=&quot;color: #cccccc;background-color: #1f1f1f;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 14px;line-height: 19px;white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;/generate_stream&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="850" y="1010" width="160" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--8" value="" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#edeaf1;" parent="1" vertex="1">
          <mxGeometry x="860" y="1050" width="10" height="10" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--9" value="" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#FFFFFF;" parent="1" vertex="1">
          <mxGeometry x="860" y="1070" width="10" height="10" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--10" value="" style="ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor=#f7f5fa;" parent="1" vertex="1">
          <mxGeometry x="860" y="1090" width="10" height="10" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--11" value="" style="curved=1;endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;" parent="1" source="XuCRXoDc4IViZIX7bLIx-3" target="uufldpvzKON03YWBHDo--3" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="640" y="860" as="sourcePoint" />
            <mxPoint x="690" y="810" as="targetPoint" />
            <Array as="points">
              <mxPoint x="720" y="650" />
              <mxPoint x="950" y="760" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--12" value="其中的成员" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=16;" parent="1" vertex="1">
          <mxGeometry x="720" y="640" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uufldpvzKON03YWBHDo--14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="uufldpvzKON03YWBHDo--4" target="uufldpvzKON03YWBHDo--5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="g-QWhA116RUE6NQJ05dA-3" target="g-QWhA116RUE6NQJ05dA-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-3" value="实际调用infer.generate_stream" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1050" y="1000" width="150" height="60" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-6" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="970" y="850" width="20" height="120" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-7" value="创建queue，存放请求" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1001" y="850" width="139" height="40" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="uufldpvzKON03YWBHDo--3" target="g-QWhA116RUE6NQJ05dA-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-9" value="创建batching_task&lt;div&gt;实际的任务处理&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1001" y="930" width="139" height="40" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-10" value="将请求存放进queue，&lt;div&gt;随后激活batching_task&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1295" y="1000" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="g-QWhA116RUE6NQJ05dA-12" value="" style="curved=1;endArrow=classic;html=1;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="g-QWhA116RUE6NQJ05dA-10" target="g-QWhA116RUE6NQJ05dA-9" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1070" y="870" as="sourcePoint" />
            <mxPoint x="1120" y="820" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1280" y="960" />
              <mxPoint x="1200" y="950" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-1" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1210" y="770" width="20" height="120" as="geometry" />
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="g-QWhA116RUE6NQJ05dA-9" target="H_vMvMSTDIy7fdAYlQ_e-1" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1180" y="940" />
              <mxPoint x="1180" y="830" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-3" value="prefill" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="750" width="99" height="30" as="geometry" />
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-4" value="decode" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="791" width="99" height="30" as="geometry" />
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-5" value="filter_batch" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="835" width="99" height="30" as="geometry" />
        </mxCell>
        <mxCell id="H_vMvMSTDIy7fdAYlQ_e-7" value="clear_cache" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1241" y="880" width="99" height="30" as="geometry" />
        </mxCell>
        <mxCell id="PLalCdW3tqJCb5XtEiZM-1" value="" style="curved=1;endArrow=classic;html=1;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" parent="1" target="XuCRXoDc4IViZIX7bLIx-5" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1350" y="840" as="sourcePoint" />
            <mxPoint x="960" y="790" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1370" y="660" />
              <mxPoint x="1180" y="580" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="PLalCdW3tqJCb5XtEiZM-2" value="调用client的方法" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="1210" y="570" width="160" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram name="text-generation-server" id="ZYx98nKoxlcXv5ATYFLJ">
    <mxGraphModel dx="344" dy="647" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="LAHEby5p-OLS9iusfp1y-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-2" target="LAHEby5p-OLS9iusfp1y-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-2" value="&lt;font style=&quot;font-size: 20px;&quot;&gt;server.py&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1660" y="530" width="210" height="70" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-6" target="v7SOr5Rd_UC0ck7hViW0-8" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2210" y="730" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2130" y="845" />
              <mxPoint x="2130" y="730" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-6" target="v7SOr5Rd_UC0ck7hViW0-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-6" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #dcdcaa;&quot;&gt;get_model&lt;/span&gt;(&lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;model_id&lt;/span&gt;, &lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;revision&lt;/span&gt;, &lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;sharded&lt;/span&gt;, &lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;quantize&lt;/span&gt;, &lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;dtype&lt;/span&gt;, &lt;span style=&quot;color: rgb(156, 220, 254);&quot;&gt;trust_remote_code&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1419.38" y="815" width="691.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-7" value="&lt;font style=&quot;font-size: 20px;&quot;&gt;获取模型&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1760" y="735" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-8" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;ATBModel&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2150" y="700" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-18" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-20" target="v7SOr5Rd_UC0ck7hViW0-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-20" target="v7SOr5Rd_UC0ck7hViW0-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-20" value="加载权重&lt;div&gt;&lt;span style=&quot;color: rgb(78, 201, 176); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; background-color: rgb(31, 31, 31);&quot;&gt;Weights 类别&lt;/span&gt;&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2842" y="745" width="288" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-22" value="记录tensor_name对应的file_name" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3283" y="745" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-24" target="v7SOr5Rd_UC0ck7hViW0-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-24" value="生成模型对象&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model_cls&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;config&lt;/span&gt;, &lt;span style=&quot;color: #9cdcfe;&quot;&gt;weights&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;例子：FlashLlamaForCausalLM&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2846" y="875" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-26" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="3220" y="873.25" width="20" height="185.5" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-27" value="主模型&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;FlashLlamaModel&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;config&lt;/span&gt;, &lt;span style=&quot;color: #9cdcfe;&quot;&gt;weights&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3250" y="859" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-28" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;size=0.5;" parent="1" vertex="1">
          <mxGeometry x="3540" y="829" width="20" height="150" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-29" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;TensorEmbedding&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3590" y="789" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-30" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 19px;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;FlashLlamaLayer&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3590" y="869" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-31" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 19px;&quot;&gt;&lt;div style=&quot;line-height: 19px;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;LlamaRMSNorm&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3590" y="949" width="140" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-32" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;lm_head&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3251" y="1009" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-33" value="模型to_device&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;to&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;weights&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;device&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2839" y="1009" width="294" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-34" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;generate_pb2_grpc&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;add_TextGenerationServiceServicer_to_server&lt;/span&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #4ec9b0;&quot;&gt;TextGenerationService&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt;, &lt;span style=&quot;color: #4ec9b0;&quot;&gt;Cache&lt;/span&gt;(), &lt;span style=&quot;color: #9cdcfe;&quot;&gt;server_urls&lt;/span&gt;), &lt;span style=&quot;color: #9cdcfe;&quot;&gt;server&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="1465" y="952" width="600" height="88" as="geometry" />
        </mxCell>
        <mxCell id="v7SOr5Rd_UC0ck7hViW0-35" value="&lt;font style=&quot;font-size: 20px;&quot;&gt;创建模型服务与模型的关联&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1770" y="875" width="270" height="80" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-3" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="2280" y="630" width="20" height="200" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-4" value="根据ATB_LLM创建model_runner&lt;div&gt;&lt;div&gt;self.model_runner = ModelRunner(model_id,rank,world_size)&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2320" y="600" width="370" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-5" value="加载权重&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model_runner&lt;/span&gt;.load_weights()&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2320" y="700" width="370" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-6" value="初始化TGI的&lt;span style=&quot;color: rgb(78, 201, 176); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;FlashCausalLM&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2320" y="800" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-7" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="2720" y="480" width="20" height="210" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-8" value="绑核&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;bind_cpus()&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2760" y="450" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-9" value="&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;get_model&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;1. 换取model_cls&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;2. 获取model_config&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;3. 获取tokenizer&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;4. 获取input_builder&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;5. 获取post_processor&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2760" y="540" width="180" height="100" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-10" value="初始化通信进程组&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #dcdcaa;&quot;&gt;initialize_distributed&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2760" y="670" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-11" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2970" y="580" as="sourcePoint" />
            <mxPoint x="3100" y="579.9999999999998" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-14" value="依据model_type获取" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2960" y="540" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-15" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="3110" y="490" width="20" height="180" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="lvHtKbhah0ZUGW8FzedY-16" target="lvHtKbhah0ZUGW8FzedY-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-16" value="&lt;div style=&quot;background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;font color=&quot;#ece6e4&quot;&gt;文件名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;atb_llm.models.&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model_type&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;.router_&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model_type&lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3150" y="470" width="380" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="lvHtKbhah0ZUGW8FzedY-17" target="lvHtKbhah0ZUGW8FzedY-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-17" value="&lt;div style=&quot;background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;font color=&quot;#f0f2f4&quot;&gt;类名&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model_type&lt;/span&gt;.capitalize()&lt;span style=&quot;color: #569cd6;&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;color: #ce9178;&quot;&gt;Router&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="3200" y="560" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-19" value="真正的模型文件名和模型类名&lt;div&gt;文件名：&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(206, 145, 120);&quot;&gt;atb_llm.models.&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;background-color: rgb(31, 31, 31); color: rgb(204, 204, 204); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;model_type&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;}.flash_causal_&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(206, 145, 120);&quot;&gt;_&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;background-color: rgb(31, 31, 31); color: rgb(204, 204, 204); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;model_type&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;类名：&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;{&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;background-color: rgb(31, 31, 31); color: rgb(204, 204, 204); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;model_type_cap&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(86, 156, 214);&quot;&gt;}&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(206, 145, 120);&quot;&gt;ForCausalLM&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="3135" y="655" width="490" height="80" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-22" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;size=0.5;" parent="1" vertex="1">
          <mxGeometry x="2740" y="760" width="90" height="270" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="lvHtKbhah0ZUGW8FzedY-5" target="lvHtKbhah0ZUGW8FzedY-22" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2690" y="850" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-24" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="v7SOr5Rd_UC0ck7hViW0-24" target="v7SOr5Rd_UC0ck7hViW0-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-25" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="3410" y="770" as="sourcePoint" />
            <mxPoint x="3570" y="820" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-26" value="提供routing，按tensorname找文件" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="3440" y="750" width="209" height="30" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-27" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;flipH=1;labelPosition=right;verticalLabelPosition=middle;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="3750" y="800" width="20" height="180" as="geometry" />
        </mxCell>
        <mxCell id="lvHtKbhah0ZUGW8FzedY-28" value="modeling_{&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;self&lt;/span&gt;&lt;span style=&quot;background-color: rgb(31, 31, 31); color: rgb(204, 204, 204); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;.&lt;/span&gt;&lt;span style=&quot;font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre; color: rgb(156, 220, 254);&quot;&gt;model_type&lt;/span&gt;}.py" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="3780" y="859" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="LAHEby5p-OLS9iusfp1y-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="LAHEby5p-OLS9iusfp1y-1" target="v7SOr5Rd_UC0ck7hViW0-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="LAHEby5p-OLS9iusfp1y-1" value="&lt;div style=&quot;font-size: 17px;&quot;&gt;启动模型服务&lt;/div&gt;server()" style="whiteSpace=wrap;html=1;rounded=1;fontSize=17;" parent="1" vertex="1">
          <mxGeometry x="1657.5" y="670" width="215" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="7Z5l7_U-OoDge3rKevBP" name="TextGenerateService-Warmup">
    <mxGraphModel dx="-307" dy="-425" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="MyRFQFkB99n3zXPcpbkC-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="MyRFQFkB99n3zXPcpbkC-2" target="MyRFQFkB99n3zXPcpbkC-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-2" value="&lt;span style=&quot;color: rgb(78, 201, 176); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;TextGenerationService.W&lt;/span&gt;armup()" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2191" y="1814" width="256" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="MyRFQFkB99n3zXPcpbkC-4" target="MyRFQFkB99n3zXPcpbkC-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-4" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch_type&lt;/span&gt;.from_pb()&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2160" y="1935" width="318" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-5" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;生成FlashCausalLMBatch&lt;/span&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2381" y="1887" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-6" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;warmup&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch&lt;/span&gt;)&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2215" y="2035" width="208" height="60" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-7" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="2431" y="2005" width="80" height="120" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="MyRFQFkB99n3zXPcpbkC-9" target="MyRFQFkB99n3zXPcpbkC-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="375kp-95cy-p363h8ejb-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="MyRFQFkB99n3zXPcpbkC-9" target="375kp-95cy-p363h8ejb-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-9" value="创建&lt;span style=&quot;color: rgb(78, 201, 176); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; white-space: pre;&quot;&gt;CacheManager&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2561" y="1975" width="150" height="40" as="geometry" />
        </mxCell>
        <mxCell id="MyRFQFkB99n3zXPcpbkC-10" value="生成token&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;generate_token&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2528.5" y="2095" width="215" height="60" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-1" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;size=0.5;" parent="1" vertex="1">
          <mxGeometry x="2790" y="2065" width="20" height="295" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="jmGDudEfzo53gIqHoHgv-2" target="jmGDudEfzo53gIqHoHgv-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-2" value="分配block&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;CACHE_MANAGER&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;allocate&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2820" y="2035" width="240" height="45" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="jmGDudEfzo53gIqHoHgv-3" target="jmGDudEfzo53gIqHoHgv-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0f3J6NgtQpcbGkRfn3y_-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jmGDudEfzo53gIqHoHgv-3" target="0f3J6NgtQpcbGkRfn3y_-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-3" value="前向推理&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;out&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;forward&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="2835" y="2130" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="Z1JwpKbQgmEyQ6z15xFg-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="jmGDudEfzo53gIqHoHgv-5" target="Z1JwpKbQgmEyQ6z15xFg-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="jmGDudEfzo53gIqHoHgv-5" value="atb模型前向&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;model&lt;/span&gt;.forward()&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;如：&lt;span style=&quot;color: rgb(78, 201, 176);&quot;&gt;FlashLlamaForCausalLM&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="3150" y="2130" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="375kp-95cy-p363h8ejb-3" value="初始分配&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;total_tokens&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;input_length&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;+&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;max_new_tokens&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;-&lt;/span&gt; &lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;needed_blocks&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #4ec9b0;&quot;&gt;math&lt;/span&gt;.&lt;span style=&quot;color: #dcdcaa;&quot;&gt;ceil&lt;/span&gt;(&lt;span style=&quot;color: #9cdcfe;&quot;&gt;total_tokens&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;/&lt;/span&gt; &lt;span style=&quot;color: #4fc1ff;&quot;&gt;BLOCK_SIZE&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;blocks&lt;/span&gt; &lt;span style=&quot;color: #d4d4d4;&quot;&gt;+=&lt;/span&gt; &lt;span style=&quot;color: #9cdcfe;&quot;&gt;needed_blocks&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;align=left;" parent="1" vertex="1">
          <mxGeometry x="2760" y="1892" width="406.5" height="83" as="geometry" />
        </mxCell>
        <mxCell id="0f3J6NgtQpcbGkRfn3y_-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="0f3J6NgtQpcbGkRfn3y_-1" target="0f3J6NgtQpcbGkRfn3y_-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="0f3J6NgtQpcbGkRfn3y_-1" value="采样&lt;div&gt;&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #9cdcfe;&quot;&gt;batch&lt;/span&gt;.&lt;span style=&quot;color: #9cdcfe;&quot;&gt;next_token_chooser&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2835" y="2230" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0f3J6NgtQpcbGkRfn3y_-3" value="更新postion_id/cu_seqlen/input_id等" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="2835" y="2330" width="210" height="60" as="geometry" />
        </mxCell>
        <mxCell id="0f3J6NgtQpcbGkRfn3y_-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" source="MyRFQFkB99n3zXPcpbkC-10" target="jmGDudEfzo53gIqHoHgv-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Z1JwpKbQgmEyQ6z15xFg-1" value="实际调用&lt;div&gt;FlashForCausalLM&lt;/div&gt;" style="whiteSpace=wrap;html=1;rounded=1;" parent="1" vertex="1">
          <mxGeometry x="3450" y="2130" width="120" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
